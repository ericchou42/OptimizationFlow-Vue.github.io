<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>條碼批量列印系統</title>
    <link href="css/styles.css?v=20250828" rel="stylesheet">
    <style>
        body {
            padding: 20px;
        }
        .table-container {
            width: 100%;
            overflow-x: auto;
        }
        .main-table th, .main-table td {
            padding: 4px 8px;
            vertical-align: middle;
            text-align: center;
            white-space: nowrap;
        }
        .box-count-input {
            width: 60px;
            text-align: center;
        }
        .batch-controls {
            margin-bottom: 15px;
            padding: 10px;
            background-color: #f0f0f0;
            border-radius: 5px;
        }
        .area-controls {
            margin-top: 15px;
            padding: 10px;
            background-color: #e9f7ef;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <div id="app">
        <div class="container-fluid">
            <!-- Controls -->
            <div class="batch-controls">
                 <div class="row">
                    <div class="col-md-4">
                        <label>批量設定日期：</label>
                        <input type="date" v-model="batchDate" class="form-control d-inline-block" style="width: auto;" @change="setBatchDate">
                    </div>
                    <div class="col-md-4">
                        <label>批量設定班別：</label>
                        <div class="btn-group" role="group">
                            <button @click="setBatchShift('日')" class="btn" :class="{'btn-primary': batchShift === '日', 'btn-outline-primary': batchShift !== '日'}">日班</button>
                            <button @click="setBatchShift('中')" class="btn" :class="{'btn-primary': batchShift === '中', 'btn-outline-primary': batchShift !== '中'}">中班</button>
                            <button @click="setBatchShift('夜')" class="btn" :class="{'btn-primary': batchShift === '夜', 'btn-outline-primary': batchShift !== '夜'}">夜班</button>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <label>批量設定箱數：</label>
                        <div class="btn-group">
                            <button @click="setBatchBoxCount(1)" class="btn btn-outline-primary">1</button>
                            <button @click="setBatchBoxCount(2)" class="btn btn-outline-primary">2</button>
                            <button @click="setBatchBoxCount(3)" class="btn btn-outline-primary">3</button>
                        </div>
                    </div>
                </div>
                <div class="area-controls">
                    <div class="row">
                        <div class="col-12">
                            <label>選擇機台區域批量操作：</label>
                            <div>
                                <button @click="selectArea('A')" class="btn btn-sm" :class="{'btn-success': selectedArea === 'A', 'btn-outline-success': selectedArea !== 'A'}">A區</button>
                                <button @click="selectArea('B')" class="btn btn-sm" :class="{'btn-success': selectedArea === 'B', 'btn-outline-success': selectedArea !== 'B'}">B區</button>
                                <button @click="selectArea('C')" class="btn btn-sm" :class="{'btn-success': selectedArea === 'C', 'btn-outline-success': selectedArea !== 'C'}">C區</button>
                                <button @click="selectArea('F')" class="btn btn-sm" :class="{'btn-success': selectedArea === 'F', 'btn-outline-success': selectedArea !== 'F'}">F區</button>
                            </div>
                        </div>
                    </div>
                    <div class="row mt-2" v-if="selectedArea">
                        <div class="col-md-6">
                            <label>為 {{ selectedArea }}區 選擇顧車人員：</label>
                            <select v-model="areaOperator" class="form-control form-control-sm" @change="setAreaOperator">
                                <option v-for="operator in operators" :key="operator" :value="operator">{{ operator }}</option>
                            </select>
                        </div>
                        <div class="col-md-6 d-flex align-items-end">
                            <button @click="printAreaBarcodes" class="btn btn-danger" :disabled="!canPrintSelectedArea">
                                批量列印 {{ selectedArea }}區 條碼 ({{ selectedAreaMachineCount }} 台)
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Loading / Error -->
            <div v-if="loading" class="text-center p-4"><div class="spinner-border"></div></div>
            <div v-if="error" class="alert alert-danger">{{ error }}</div>
            <div v-if="message" class="alert" :class="messageType">{{ message }}</div>
            <div v-if="pythonErrors" class="alert alert-warning"><pre>{{ pythonErrors }}</pre></div>

            <!-- Main Table -->
            <div v-if="!loading && !error" class="table-container">
                <table class="table table-bordered table-sm main-table">
                    <thead class="table-light">
                        <tr>
                            <th>機台</th>
                            <th>工單號</th>
                            <th>品名</th>
                            <th>日期</th>
                            <th>顧車人員</th>
                            <th>班別</th>
                            <th>後續單位</th>
                            <th>工單數</th>
                            <th>累計產數</th>
                            <th>日產量</th>
                            <th>箱數</th>
                            <th>列印箱號</th>
                            <th>單張列印</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr v-for="item in data" :key="item.car" :class="{ 'table-warning': item.isFinishingSoon }">
                            <td>{{ item.car }}</td>
                            <td>{{ item.currentWorkOrder }}</td>
                            <td>{{ item.productName }}</td>
                            <td><input type="date" v-model="item.barcodeDate" class="form-control form-control-sm"></td>
                            <td>
                                <select v-model="item.operator" class="form-control form-control-sm">
                                    <option v-for="op in operators" :key="op" :value="op">{{ op }}</option>
                                </select>
                            </td>
                            <td>
                                <select v-model="item.shift" class="form-control form-control-sm">
                                    <option value="日">日</option>
                                    <option value="中">中</option>
                                    <option value="夜">夜</option>
                                </select>
                            </td>
                            <td>
                                <select v-model="item.nextUnit" class="form-control form-control-sm">
                                    <option value="電">電</option>
                                    <option value="加工">加工</option>
                                </select>
                            </td>
                            <td>{{ item.workOrderCount }}</td>
                            <td>{{ item.cumulativeCount }}</td>
                            <td>{{ item.dailyQuota }}</td>
                            <td><input type="number" v-model.number="item.boxCount" class="form-control form-control-sm box-count-input" min="1" max="9"></td>
                            <td>
                                <select v-model="item.reprintBoxCount" class="form-control form-control-sm">
                                    <option v-for="n in 9" :key="n" :value="String(n).padStart(2, '0')">{{ String(n).padStart(2, '0') }}</option>
                                </select>
                            </td>
                            <td>
                                <button @click="reprintBarcode(item)" class="btn btn-sm btn-success" :disabled="!item.reprintBoxCount || !item.currentWorkOrder">列印</button>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <script src="js/vue.min.js"></script>
    <script src="js/axios.min.js"></script>
    <script>
        const { createApp, ref, computed, onMounted } = Vue;

        createApp({
            setup() {
                const data = ref([]);
                const loading = ref(true);
                const error = ref(null);
                const message = ref('');
                const messageType = ref('');
                const pythonErrors = ref('');
                const batchShift = ref('日');
                const batchDate = ref(new Date().toISOString().slice(0, 10));
                const selectedArea = ref('');
                const areaOperator = ref('');
                const operators = ref(['黃志強', '吳俊龍', '洪昭南', '陳啟昌', '周堉澤', '李正良', '陳文琪', '林俊男', '劉原良', '楊松川', '郭泳宏', '黃富春', '盧志瑋', '阮文王']);

                const selectedAreaMachineCount = computed(() => {
                    if (!selectedArea.value) return 0;
                    return data.value.filter(item => item.car.startsWith(selectedArea.value)).length;
                });

                const canPrintSelectedArea = computed(() => {
                    if (!selectedArea.value || selectedAreaMachineCount.value === 0) return false;
                    const areaMachines = data.value.filter(item => item.car.startsWith(selectedArea.value));
                    return areaMachines.every(item => item.currentWorkOrder && item.operator && item.barcodeDate && item.boxCount > 0);
                });

                function formatDateYYYYMMDD(dateString) {
                    return dateString ? dateString.replace(/-/g, '') : '';
                }

                function getShiftNumber(shift) {
                    return { '日': '1', '中': '2', '夜': '3' }[shift] || '1';
                }

                const showMessage = (msg, type, duration = 3000) => {
                    message.value = msg;
                    messageType.value = type;
                    if (duration > 0) {
                        setTimeout(() => { message.value = ''; }, duration);
                    }
                };

                const fetchData = async () => {
                    try {
                        loading.value = true;
                        error.value = null;
                        const response = await axios.get(`./backend/barcodePrint.php?t=${new Date().getTime()}`);
                        if (response.data.error) {
                            throw new Error(response.data.error);
                        }
                        data.value = response.data.map(item => ({
                            ...item,
                            boxCount: 1, // Set default box count to 1
                            reprintBoxCount: '01',
                            shift: batchShift.value,
                            nextUnit: '電',
                            barcodeDate: batchDate.value,
                            operator: operators.value[0] || ''
                        }));
                    } catch (err) {
                        error.value = `獲取數據失敗: ${err.message}`;
                        console.error(err);
                    } finally {
                        loading.value = false;
                    }
                };

                const setBatchShift = (shift) => {
                    batchShift.value = shift;
                    data.value.forEach(item => { item.shift = shift; });
                };

                const setBatchDate = () => {
                    data.value.forEach(item => { item.barcodeDate = batchDate.value; });
                };

                const setBatchBoxCount = (count) => {
                    data.value.forEach(item => { item.boxCount = count; });
                };

                const selectArea = (area) => {
                    selectedArea.value = area;
                    areaOperator.value = operators.value[0] || '';
                };

                const setAreaOperator = () => {
                    if (!selectedArea.value || !areaOperator.value) return;
                    data.value.forEach(item => {
                        if (item.car.startsWith(selectedArea.value)) {
                            item.operator = areaOperator.value;
                        }
                    });
                };

                const printAreaBarcodes = async () => {
                    if (!canPrintSelectedArea.value) return;
                    const areaMachines = data.value.filter(item => item.car.startsWith(selectedArea.value));
                    showMessage(`正在為 ${selectedArea.value}區 批量列印 ${areaMachines.length} 台機台的條碼...`, 'alert-info', 0);
                    pythonErrors.value = '';
                    let errors = [];

                    for (const item of areaMachines) {
                        const res = await print(item);
                        if (!res.success) {
                            errors.push(res.message);
                        }
                    }
                    message.value = ''; // Clear loading message
                    if (errors.length > 0) {
                        pythonErrors.value = errors.join('\n\n');
                    }
                };

                const reprintBarcode = async (item) => {
                    const res = await print(item, true);
                    if (res.success) {
                        showMessage('重印成功', 'alert-success');
                    } else {
                        showMessage(res.message, 'alert-danger');
                    }
                };

                const print = async (item, isReprint = false) => {
                    const action = isReprint ? 'reprint_barcode' : 'print_box_count';
                    const payload = {
                        car: item.car,
                        workOrder: item.currentWorkOrder,
                        productName: item.productName,
                        boxCount: isReprint ? 1 : item.boxCount,
                        boxNumber: isReprint ? item.reprintBoxCount : null,
                        operator: item.operator,
                        nextUnit: item.nextUnit,
                        shift: item.shift,
                        date: formatDateYYYYMMDD(item.barcodeDate),
                        shiftNumber: getShiftNumber(item.shift)
                    };
                    try {
                        const response = await axios.post(`./backend/barcodePrint.php?action=${action}`, payload);
                        if (response.data.success) {
                            return { success: true };
                        } else {
                            return { success: false, message: `機台 ${item.car}: ${response.data.error}` };
                        }
                    } catch (err) {
                        return { success: false, message: `機台 ${item.car} 請求失敗: ${err.message}` };
                    }
                };

                onMounted(fetchData);

                return {
                    data,
                    loading,
                    error,
                    message,
                    messageType,
                    pythonErrors,
                    batchShift,
                    batchDate,
                    selectedArea,
                    areaOperator,
                    operators,
                    selectedAreaMachineCount,
                    canPrintSelectedArea,
                    setBatchShift,
                    setBatchDate,
                    setBatchBoxCount,
                    selectArea,
                    setAreaOperator,
                    printAreaBarcodes,
                    reprintBarcode
                };
            }
        }).mount('#app');
    </script>
</body>
</html>